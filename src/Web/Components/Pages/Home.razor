@page "/"
@using System.IO
@using Web.Services
@rendermode InteractiveServer
@inject PyMuPdfService PdfReaderService
@inject PdfPigService PdfPigService
@inject IJSRuntime JsRuntime

<PageTitle>PDF Text Extraction Comparison - Memoranda</PageTitle>

<div class="containerx mt-4">
    <div class="row" style="text-align: center">
        <div class="col-12">
            <h2 class="mb-4">Compare Extraction between <a href="https://pymupdf.readthedocs.io/" target="_blank">PyMuPdf</a>
                <img src="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/icons/python/python-original-wordmark.svg" height="50px" width="50px" alt="python"/>
                and <a href="https://github.com/UglyToad/PdfPig" target="_blank">PdfPig</a>
                <img src="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/icons/csharp/csharp-original.svg" height="50px" width="50px" alt="csharp" />
            </h2>
            <section class="tech-stack-strip">
                <div class="container">
                    <span class="powered-by">Powered by</span>
                    <div class="tech-logos">
                        <a href="https://aspire.dev/" target="_blank" class="tech-logo aspire" title="Aspire">
                            <img src="https://aspire.dev/_astro/aspire-logo-32.DGHSFRgf.svg" alt="Aspire" />
                            <span class="tech-label">Aspire</span>
                        </a>
                        <a href="https://dotnet.microsoft.com/apps/aspnet/web-apps/blazor" target="_blank" class="tech-logo blazor" title="Blazor">
                            <img src="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/icons/blazor/blazor-original.svg" alt="Blazor" />
                            <span class="tech-label">Blazor</span>
                        </a>
                        <a href="https://www.python.org/" target="_blank" class="tech-logo python" title="Python">
                            <img src="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/icons/python/python-original.svg" alt="Python" />
                            <span class="tech-label">Python</span>
                        </a>
                        <a href="https://dotnet.microsoft.com/languages/csharp" target="_blank" class="tech-logo csharp" title="C#">
                            <img src="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/icons/csharp/csharp-original.svg" alt="C#" />
                            <span class="tech-label">C#</span>
                        </a>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div class="row mb-4" style="text-align: center">
        <div class="col-12">
            <div class="short card">
                <div class="card-header">
                    <h5 class="mb-0">Upload PDF</h5>
                </div>
                <div class="card-body">
                    <InputFile OnChange="HandleFileSelected" class="form-control mb-3" accept=".pdf" />
                    @if (!string.IsNullOrEmpty(_uploadedFileName))
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> File selected: @_uploadedFileName
                        </div>
                    }
                    <button class="btn btn-primary" @onclick="CompareExtraction" disabled="@(_isProcessing || _selectedFile == null)">
                        @if (_isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <text>Processing...</text>
                        }
                        else
                        {
                            <text>Compare Extraction</text>
                        }
                    </button>
                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <div class="alert alert-danger mt-3">
                            <i class="bi bi-exclamation-triangle"></i> @_errorMessage
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (_hasResults)
    {
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Comparison Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <strong>PyMuPdf</strong><br/>
                                <span class="badge bg-info">@_httpClientTextLength chars</span>
                                <span class="badge bg-secondary">@FormatTime(_httpClientElapsed)</span>
                            </div>
                            <div class="col-md-4">
                                <strong>PdfPig</strong><br/>
                                <span class="badge bg-info">@_pdfPigTextLength chars</span>
                                <span class="badge bg-secondary">@FormatTime(_pdfPigElapsed)</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Result</strong><br/>
                                <span class="badge @(_textsMatch ? "bg-success" : "bg-warning")">
                                    @(_textsMatch ? "Identical" : "Different")
                                </span>
                                @{
                                    var faster = _httpClientElapsed < _pdfPigElapsed ? "PyMuPdf" : "PdfPig";
                                    var diff = Math.Abs((_httpClientElapsed - _pdfPigElapsed).TotalMilliseconds);
                                }
                                <span class="badge bg-dark">@faster +@diff.ToString("F0")ms</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">PyMuPdf</h5>
                        @if (!string.IsNullOrEmpty(_httpClientText))
                        {
                            <button class="btn-copy" @onclick="() => CopyToClipboard(_httpClientText, 1)" title="Copy to clipboard">
                                @if (_copiedIndex == 1)
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                }
                                else
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                }
                            </button>
                        }
                    </div>
                    <div class="card-body">
                        <div class="text-output">
                            @if (string.IsNullOrEmpty(_httpClientText))
                            {
                                <em class="text-muted">No text extracted</em>
                            }
                            else
                            {
                                <pre>@_httpClientText</pre>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Pdf Pig</h5>
                        @if (!string.IsNullOrEmpty(_pdfPigText))
                        {
                            <button class="btn-copy" @onclick="() => CopyToClipboard(_pdfPigText, 2)" title="Copy to clipboard">
                                @if (_copiedIndex == 2)
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                }
                                else
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                }
                            </button>
                        }
                    </div>
                    <div class="card-body">
                        <div class="text-output">
                            @if (string.IsNullOrEmpty(_pdfPigText))
                            {
                                <em class="text-muted">No text extracted</em>
                            }
                            else
                            {
                                <pre>@_pdfPigText</pre>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .text-output {
        max-height: 600px;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
    }

    .text-output pre {
        margin: 0;
        /*white-space: pre-wrap;
        word-wrap: break-word;*/
        overflow: visible;
    }

    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
    }

    .btn-copy {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.4rem;
        border: none;
        background: none;
        color: var(--kaizen-gray);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-copy:hover {
        background-color: rgba(0, 0, 0, 0.08);
        color: var(--kaizen-orange);
    }

    .btn-copy svg {
        transition: transform 0.2s ease;
    }

    .btn-copy:active svg {
        transform: scale(0.9);
    }
</style>

@code {
    private IBrowserFile? _selectedFile;
    private string _uploadedFileName = string.Empty;
    private bool _isProcessing;
    private string _errorMessage = string.Empty;
    private bool _hasResults;

    private string _httpClientText = string.Empty;
    private string _pdfPigText = string.Empty;
    private int _httpClientTextLength;
    private int _pdfPigTextLength;
    private TimeSpan _httpClientElapsed;
    private TimeSpan _pdfPigElapsed;
    private bool _textsMatch;

    private int _copiedIndex;

    private async Task CopyToClipboard(string text, int index)
    {
        await JsRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        _copiedIndex = index;
        StateHasChanged();

        await Task.Delay(2000);
        _copiedIndex = 0;
        StateHasChanged();
    }

    private static string FormatTime(TimeSpan elapsed)
    {
        if (elapsed.TotalSeconds >= 1)
            return $"{elapsed.TotalSeconds:F2}s";
        return $"{elapsed.TotalMilliseconds:F0}ms";
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _uploadedFileName = e.File.Name;
        _hasResults = false;
        _errorMessage = string.Empty;
        _httpClientText = string.Empty;
        _pdfPigText = string.Empty;
        _httpClientElapsed = TimeSpan.Zero;
        _pdfPigElapsed = TimeSpan.Zero;
        StateHasChanged();
    }

    private async Task CompareExtraction()
    {
        if (_selectedFile == null)
        {
            _errorMessage = "Please select a file first";
            return;
        }

        _isProcessing = true;
        _errorMessage = string.Empty;
        _hasResults = false;
        _httpClientText = string.Empty;
        _pdfPigText = string.Empty;
        _httpClientElapsed = TimeSpan.Zero;
        _pdfPigElapsed = TimeSpan.Zero;

        try
        {
            // Read the file stream
            await using var fileStream = _selectedFile.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024); // 100MB max

            // Create memory streams for both services (they may consume the stream)
            var httpClientStream = new MemoryStream();
            var pdfPigStream = new MemoryStream();

            await fileStream.CopyToAsync(httpClientStream);
            httpClientStream.Position = 0;
            await httpClientStream.CopyToAsync(pdfPigStream);

            httpClientStream.Position = 0;
            pdfPigStream.Position = 0;

            // Extract text from both services in parallel
            var httpClientTask = PdfReaderService.ExtractText(httpClientStream, _selectedFile.Name);
            var pdfPigTask = PdfPigService.ExtractText(pdfPigStream, _selectedFile.Name);

            await Task.WhenAll(httpClientTask, pdfPigTask);

            var httpClientResult = await httpClientTask;
            var pdfPigResult = await pdfPigTask;

            _httpClientText = httpClientResult.Text;
            _pdfPigText = pdfPigResult.Text;
            _httpClientElapsed = httpClientResult.ElapsedTime;
            _pdfPigElapsed = pdfPigResult.ElapsedTime;

            _httpClientTextLength = _httpClientText.Length;
            _pdfPigTextLength = _pdfPigText.Length;

            // Compare texts ignoring whitespace differences
            var normalized1 = NormalizeTextForComparison(_httpClientText);
            var normalized2 = NormalizeTextForComparison(_pdfPigText);
            _textsMatch = normalized1 == normalized2;

            _hasResults = true;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error processing PDF: {ex}";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private static string NormalizeTextForComparison(string text)
    {
        // Normalize entire text: collapse multiple whitespace to single spaces, normalize line breaks
        var normalized = System.Text.RegularExpressions.Regex.Replace(text, @"\r\n|\r|\n", "\n"); // Normalize line breaks
        normalized = System.Text.RegularExpressions.Regex.Replace(normalized, @"[ \t]+", " "); // Collapse horizontal whitespace
        normalized = System.Text.RegularExpressions.Regex.Replace(normalized, @"\n{3,}", "\n\n"); // Collapse multiple newlines to double newline max
        return normalized.Trim();
    }
}

